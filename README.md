# iSalah ⦁ Уведомления на намаз

## Функционал

- **Главная функция _(смысл всего проекта)_: [`app/scheduler.py`](/src/app/scheduler.py).** Когда наступает сделать время определённого намаза, бот отправляет уведомление пользователям. Подробнее раписано ниже.
- **Подсчёт стастистики.** Когда человек получает уведомление о намазе, он может отметить, что выполнил его. Это на совести пользователя. Те намазы, что не были отмечены, попадают в статистику пропущенных, и человек всегда знает сколько ему нужно восполнить.
- **Просмотр сегодняшнего расписания.** Простое обращение к **Aladhan API**, распаковка данных и форматирование текста.
- **Автоматическая подстройка под часовой пояс пользователя.** Во всех моментах, где используется показ времени, оно выводится с учётом часового пояса пользователя, которое было получено при его регистрации _(`/start`)_ и подтверждённое им же.
- **Настройки.** Можно установить мазхаб _(на выбор даётся Ханафи и Шафии (в Маликийском и Ханбалийском мазхабах время идентично Шафиитскому))_, установить косметические правки, управлять данными _(выключить или сбросить статистику, удалить себя из БД)_.

### Принцип работы `scheduler.py`

#### Daily Refresh _(`update_daily_timings()`)_

Задача этой функции каждый день в 00:01 _(По МСК)_ обновлять данные в таблице `timings` _(подробнее ниже. Кратко: у кого во сколько наступает время того или иного намаза)_. Берёт Telegram ID случайного человека, обращается к **Aladhan API** _(с помощью функции [`get_pray_times()`](/src/app/utils.py). Как раз-таки она и требует TG-ID)_. Полученные данные подставляются всем другим пользователям, у кого параметры совпадают с "материнским" юзером.

#### Ticker _(`check_and_notify()`)_

Вызывается каждую минуту _(через `start_scheduler()`)_. Проверяет время намаза каждого юзера. Если оно совпадает с его локальным временем, то отправляет ему уведомление. **Ticker** сразу адаптируется под настройки пользователя.

## Структура

### Назначение файлов _(/src/app/)_

1. **[`handlers.py`](/src/app/handlers.py)** — команды _(`Command()`)_ и `F.text ==` _(для reply-клавиатур)_.
2. **[`callbacks.py`](/src/app/callbacks.py)** — коллбэки.
3. **[`keyboards.py`](/src/app/keyboards.py)** — клавиатуры _(и reply, и inline, и в виде переменных, и в виде функций)_.
4. **[`data.py`](/src/app/data.py)** — хранит в себе все словари, FSM- и датаклассы.
5. **[`utils.py`](/src/app/utils.py)** — вспомогательные функции, например `get_pray_times()`, которая обращается к **Aladhan API**.
6. **[`scheduler.py`](/src/app/scheduler.py)** — непосредственно планировщик, который рассылает сообщения о наступившем намазе.

### Таблицы в [базе данных](/src/database/scheme.sql)

1. **general** — город, часовой пояс, широта и долгота, дата регистрации, статистика.
2. **salah** — "ежедневник". В разработке _(подробнее ниже)_.
3. **settings** — настройки каждого пользователя. Все настройки _(кроме языка, и тот в разработке)_ хранятся в формате boolean, где `0` — настройка по-умолчанию, а `1` — противоположная ей. **Исключение:** параметр `"madhab"`, где `0` — это Ханафи, а `1` — Шафии.
4. **stage** — хранит особое состояние пользователя, которое требует подтверждение. Это позволяет иметь одну универсальную данет-клавиатуру _([`kb_yesno`](/src/app/keyboards.py))_ и реализовать всю её логику в одной функции в `match case`. Ознакомьтесь со словарём `stages` в файле [`app/utils.py`](/src/app/utils.py).
    - `0` — Нет особенного состояния;
    - `1` — Регистрация: подтверждение города;
    - `2` — Настройки: сброс статистики;
    - `3` — Настройки: полное удаление себя из БД.
5. **timings** — хранит в себе данные о том, когда у каждого пользователя наступит время того или иного намаза. Время хранится в формате `чч:мм`.

## В разработке

1. Локализация на английский язык.
2. Добавление в группы.
3. Показывать в статистике намазы, которые пользователь сегодня отметил как сделанные _(таблица `salahs`)_.
4. Просмотр расписания на завтра.
5. Возможность изменить город.
6. В косметических настройках добавить параметр, который будет называть молитву либо салят _(по-арабски)_, либо намаз _(по-русски)_.